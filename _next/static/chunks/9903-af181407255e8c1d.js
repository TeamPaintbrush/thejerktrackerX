"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9903],{39903:(e,t,r)=>{r.d(t,{DynamoDBService:()=>l});var a=r(79093),i=r(50696),n=r(33051),o=r(95704);let s=e=>{if(void 0!==e)return e instanceof Date?e.toISOString():Array.isArray(e)?e.map(e=>s(e)).filter(e=>void 0!==e):e&&"object"==typeof e?Object.entries(e).reduce((e,t)=>{let[r,a]=t,i=s(a);return void 0!==i&&(e[r]=i),e},{}):e};class l{static sanitizeEnvValue(e){if(!e)return;let t=e.trim();return t.length?t:void 0}static getConfig(){return{region:this.sanitizeEnvValue("us-east-1")||"us-east-1",tableName:this.sanitizeEnvValue("jerktracker-orders")||"jerktracker-orders",enableDynamoDB:"false"!==this.sanitizeEnvValue("true"),fallbackMode:"true"===this.sanitizeEnvValue("false")}}static getUsersTableName(){return this.sanitizeEnvValue("jerktracker-users")||"jerktracker-users"}static async initClient(){if(this.client)return this.client;let e=this.getConfig();if(!e.enableDynamoDB||e.fallbackMode)return console.log("DynamoDB disabled or in fallback mode, using in-memory storage"),this.fallbackMode=!0,null;try{let t;{let r=o.env.NEXT_PUBLIC_COGNITO_IDENTITY_POOL_ID;if(!r)return this.fallbackMode=!0,null;t=new a.M({region:e.region,credentials:(0,n.s)({identityPoolId:r,clientConfig:{region:e.region}})})}return this.client=i.TG.from(t),await this.testConnection(),console.log("DynamoDB client initialized successfully"),this.client}catch(e){return console.error("Failed to initialize DynamoDB client:",e),this.fallbackMode=!0,null}}static async testConnection(){try{if(!this.client)return!1;let e=this.getConfig();return await this.client.send(new i.Zy({TableName:e.tableName,Limit:1})),console.log("DynamoDB connection test successful"),!0}catch(e){return console.error("DynamoDB connection test failed:",e),e instanceof Error&&console.error("Error details:",{name:e.name,message:e.message,stack:e.stack}),!1}}static getFromMemory(e){return this.memoryStorage[e]||[]}static setInMemory(e,t){this.memoryStorage[e]=t}static async createOrder(e){let t=await this.initClient();return t&&!this.fallbackMode?this.createOrderDynamoDB(e,t):(console.log("Using in-memory fallback for createOrder"),this.createOrderMemory(e))}static async getAllOrders(){let e=await this.initClient();return e&&!this.fallbackMode?this.getAllOrdersDynamoDB(e):(console.log("Using memory fallback for getAllOrders"),this.getAllOrdersMemory())}static async getOrderById(e){let t=await this.initClient();return t&&!this.fallbackMode?this.getOrderByIdDynamoDB(e,t):(console.log("Using memory fallback for getOrderById"),this.getOrderByIdMemory(e))}static async updateOrder(e,t){let r=await this.initClient();return r&&!this.fallbackMode?this.updateOrderDynamoDB(e,t,r):(console.log("Using memory fallback for updateOrder"),this.updateOrderMemory(e,t))}static async updateOrderStatus(e,t){let r={status:t};return"picked_up"===t&&(r.pickedUpAt=new Date),"delivered"===t&&(r.deliveredAt=new Date),this.updateOrder(e,r)}static async transferOrder(e,t,r){try{let a=await this.getOrderById(e);if(!a)throw Error("Order not found");let i=await this.getLocationById(t);if(!i)throw Error("Target location not found");let n=a.location.locationId,o={location:{...a.location,locationId:t,locationName:i.name,businessId:i.businessId,transferredAt:new Date,transferReason:r||"Location transfer",previousLocationId:n}},s=await this.updateOrder(e,o);return n&&"default"!==n&&await this.updateLocationUsage(n,-1),await this.updateLocationUsage(t,1),s}catch(e){throw console.error("Error transferring order:",e),e}}static async getServiceStatus(){let e=this.getConfig(),t=await this.initClient(),r=t&&!this.fallbackMode?"dynamodb":"memory";return{dynamoDBAvailable:!!t&&!this.fallbackMode,fallbackMode:this.fallbackMode,storageType:r,region:e.region,tableName:e.tableName}}static async createOrderDynamoDB(e,t){let r=this.getConfig(),a={...e,id:Date.now().toString()+"_"+Math.random().toString(36).substr(2,9),createdAt:new Date};try{var n;let e={...a,createdAt:a.createdAt.toISOString(),pickedUpAt:null==(n=a.pickedUpAt)?void 0:n.toISOString()};return await t.send(new i.Z$({TableName:r.tableName,Item:e})),console.log("Order created in DynamoDB:",a.id),this.createOrderMemory(a),a}catch(t){return console.error("Error creating order in DynamoDB:",t),this.createOrderMemory(e)}}static async getAllOrdersDynamoDB(e){let t=this.getConfig();try{let r=((await e.send(new i.Zy({TableName:t.tableName}))).Items||[]).map(e=>({...e,createdAt:new Date(e.createdAt),pickedUpAt:e.pickedUpAt?new Date(e.pickedUpAt):void 0}));console.log("Loaded ".concat(r.length," orders from DynamoDB"));try{this.setInMemory(this.ORDER_MEMORY_KEY,r)}catch(e){console.warn("Failed to cache orders in memory:",e)}return r}catch(e){return console.error("Error fetching orders from DynamoDB:",e),this.getAllOrdersMemory()}}static async getOrderByIdDynamoDB(e,t){let r=this.getConfig();try{let a=await t.send(new i.s$({TableName:r.tableName,Key:{id:e}}));if(a.Item){let e={...a.Item,createdAt:new Date(a.Item.createdAt),pickedUpAt:a.Item.pickedUpAt?new Date(a.Item.pickedUpAt):void 0};return console.log("Order found in DynamoDB:",e.id,e.orderNumber),e}return console.warn("Order not found in DynamoDB:",e),null}catch(t){return console.error("Error fetching order from DynamoDB:",t),this.getOrderByIdMemory(e)}}static async updateOrderDynamoDB(e,t,r){let a=this.getConfig();try{"picked_up"!==t.status||t.pickedUpAt||(t.pickedUpAt=new Date);let n=Object.keys(t).filter(e=>"id"!==e&&"createdAt"!==e).map(e=>"#".concat(e," = :").concat(e)).join(", "),o=Object.keys(t).filter(e=>"id"!==e&&"createdAt"!==e).reduce((e,t)=>({...e,["#".concat(t)]:t}),{}),s=Object.keys(t).filter(e=>"id"!==e&&"createdAt"!==e).reduce((e,r)=>{let a=t[r];return{...e,[":".concat(r)]:a instanceof Date?a.toISOString():a}},{});return await r.send(new i.fR({TableName:a.tableName,Key:{id:e},UpdateExpression:"SET ".concat(n),ExpressionAttributeNames:o,ExpressionAttributeValues:s,ReturnValues:"ALL_NEW"})),console.log("Order updated in DynamoDB:",e),this.updateOrderMemory(e,t),this.getOrderByIdDynamoDB(e,r)}catch(r){return console.error("Error updating order in DynamoDB:",r),this.updateOrderMemory(e,t)}}static testStorage(){try{let e="test_"+Date.now(),t={id:"test_"+Date.now(),orderNumber:"TEST001",customerName:"Test Customer",customerEmail:"test@example.com",orderDetails:"Test order details",status:"pending",createdAt:new Date,location:{locationId:"test_location",businessId:"test_business",verificationStatus:"verified"}};this.setInMemory(e,[t]);let r=this.getFromMemory(e);if(r&&Array.isArray(r)&&1===r.length&&r[0].id===t.id)return this.setInMemory(e,[]),{available:!0,type:"memory"};return{available:!1,type:"unknown",error:"Memory storage test failed"}}catch(e){return{available:!1,type:"error",error:e instanceof Error?e.message:"Unknown error"}}}static createOrderMemory(e){let t;t="id"in e&&"createdAt"in e?JSON.parse(JSON.stringify(e)):{...JSON.parse(JSON.stringify(e)),id:Date.now().toString()+"_"+Math.random().toString(36).substr(2,9),createdAt:new Date};let r=[...this.getAllOrdersMemory()],a=r.findIndex(e=>e.id===t.id);return a>=0?r[a]=t:r.push(t),this.setInMemory(this.ORDER_MEMORY_KEY,r),console.log("Order saved to memory:",t.id),t}static getAllOrdersMemory(){try{let e=this.getFromMemory(this.ORDER_MEMORY_KEY);if(!e||!Array.isArray(e))return console.log("No orders found in memory"),[];let t=e.map(e=>({...e,createdAt:e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt),pickedUpAt:e.pickedUpAt?e.pickedUpAt instanceof Date?e.pickedUpAt:new Date(e.pickedUpAt):void 0,deliveredAt:e.deliveredAt?e.deliveredAt instanceof Date?e.deliveredAt:new Date(e.deliveredAt):void 0}));return console.log("Loaded ".concat(t.length," orders from memory")),t}catch(e){return console.error("Error loading orders from memory:",e),[]}}static getOrderByIdMemory(e){let t=this.getAllOrdersMemory(),r=t.find(t=>t.id===e);return r?console.log("Order found in memory:",r.id,r.orderNumber):(console.warn("Order not found in memory:",e),console.log("Available order IDs:",t.map(e=>e.id))),r||null}static updateOrderMemory(e,t){let r=this.getAllOrdersMemory(),a=r.findIndex(t=>t.id===e);if(-1===a)return console.warn("Order not found for update in memory:",e),null;let i={...t};"picked_up"!==i.status||i.pickedUpAt||(i.pickedUpAt=new Date);let n={...JSON.parse(JSON.stringify(r[a])),...i},o=[...r];return o[a]=n,this.setInMemory(this.ORDER_MEMORY_KEY,o),console.log("Order updated successfully in memory:",e),n}static async autoCompleteOverdueOrders(){try{let e=await this.getAllOrders(),t=new Date;for(let r of e)if("picked_up"===r.status&&r.pickedUpAt){let e=new Date(r.pickedUpAt),a=t.getTime()-e.getTime();a>18e5&&(await this.updateOrder(r.id,{status:"delivered",deliveredAt:t,deliveryConfirmationMethod:"auto-timeout"}),console.log("Auto-completed order ".concat(r.orderNumber," after ").concat(Math.round(a/6e4)," minutes (assumed delivered)")))}}catch(e){console.error("Error in auto-complete process:",e)}}static startAutoCompleteTimer(){this.autoCompleteOverdueOrders(),setInterval(()=>{this.autoCompleteOverdueOrders()},6e5)}static async getUserByEmail(e){try{var t;let r=await this.initClient();if(!r||this.fallbackMode)return[{id:"1",name:"Admin User",email:"admin@thejerktracker.com",password:"$2b$12$TrF0jtIKlujqXTqT/5KvBeyei5TFNRo2Pvs0lqzNh1UF808kW10ci",role:"admin",createdAt:new Date}].find(t=>t.email===e)||null;return(null==(t=(await r.send(new i.Zy({TableName:this.getUsersTableName(),FilterExpression:"email = :email",ExpressionAttributeValues:{":email":e}}))).Items)?void 0:t[0])||null}catch(e){return console.error("Error getting user by email:",e),null}}static async createLocation(e){try{var t;let r={...e,id:"loc_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),createdAt:new Date,updatedAt:new Date};if(this.fallbackMode){let e=this.getFromMemory("locations")||[];return e.push(r),this.setInMemory("locations",e),console.log("Created location in memory:",r.id),r}let a=await this.initClient();if(!a)return console.error("DynamoDB client not available"),null;let n=this.getConfig(),o=s({...r,type:"location",createdAt:r.createdAt.toISOString(),updatedAt:null==(t=r.updatedAt)?void 0:t.toISOString()}),l=new i.Z$({TableName:n.tableName,Item:o});return await a.send(l),console.log("Location created successfully:",r.id),r}catch(e){return console.error("Error creating location:",e),null}}static async getLocationsByBusinessId(e){try{if(this.fallbackMode)return(this.getFromMemory("locations")||[]).filter(t=>t.businessId===e);let t=await this.initClient();if(!t)return[];let r=this.getConfig(),a=new i.Zy({TableName:r.tableName,FilterExpression:"#type = :type AND businessId = :businessId",ExpressionAttributeNames:{"#type":"type"},ExpressionAttributeValues:{":type":"location",":businessId":e}});return((await t.send(a)).Items||[]).map(e=>({...e,createdAt:new Date(e.createdAt),updatedAt:e.updatedAt?new Date(e.updatedAt):void 0}))}catch(e){return console.error("Error getting locations by business ID:",e),[]}}static async getLocationById(e){try{if(this.fallbackMode)return(this.getFromMemory("locations")||[]).find(t=>t.id===e)||null;let t=await this.initClient();if(!t)return null;let r=this.getConfig(),a=new i.s$({TableName:r.tableName,Key:{id:e}}),n=await t.send(a);if(!n.Item||"location"!==n.Item.type)return null;return{...n.Item,createdAt:new Date(n.Item.createdAt),updatedAt:n.Item.updatedAt?new Date(n.Item.updatedAt):void 0}}catch(e){return console.error("Error getting location by ID:",e),null}}static async updateLocation(e,t){try{if(this.fallbackMode){let r=this.getFromMemory("locations")||[],a=r.findIndex(t=>t.id===e);if(-1===a)return!1;return r[a]={...r[a],...t,updatedAt:new Date},this.setInMemory("locations",r),!0}let r=await this.initClient();if(!r)return!1;let a=this.getConfig(),n=s(t),o=Object.entries(n).filter(e=>{let[,t]=e;return void 0!==t});if(0===o.length)return console.warn("No valid location updates provided"),!1;let l=o.map(e=>{let[t]=e;return"#".concat(t," = :").concat(t)}).join(", "),c=o.reduce((e,t)=>{let[r]=t;return e["#".concat(r)]=r,e},{}),d=o.reduce((e,t)=>{let[r,a]=t;return e[":".concat(r)]=a,e},{});c["#updatedAt"]="updatedAt",d[":updatedAt"]=new Date().toISOString();let u=new i.fR({TableName:a.tableName,Key:{id:e},UpdateExpression:"SET ".concat(l,", #updatedAt = :updatedAt"),ExpressionAttributeNames:{...c,"#type":"type"},ExpressionAttributeValues:{...d,":type":"location"},ConditionExpression:"attribute_exists(id) AND #type = :type"});return await r.send(u),!0}catch(e){return console.error("Error updating location:",e),!1}}static async deleteLocation(e){try{if(this.fallbackMode){let t=this.getFromMemory("locations")||[],r=t.filter(t=>t.id!==e);if(r.length===t.length)return!1;return this.setInMemory("locations",r),!0}let t=await this.initClient();if(!t)return!1;let r=this.getConfig(),a=new i.Rj({TableName:r.tableName,Key:{id:e},ConditionExpression:"attribute_exists(id) AND #type = :type",ExpressionAttributeNames:{"#type":"type"},ExpressionAttributeValues:{":type":"location"}});return await t.send(a),!0}catch(e){return console.error("Error deleting location:",e),!1}}static async verifyLocationAddress(e){try{let t="".concat(e.street,", ").concat(e.city,", ").concat(e.state," ").concat(e.zipCode,", ").concat(e.country);if(!e.street||!e.city||!e.state||!e.zipCode)return{isValid:!1,error:"Incomplete address information"};let r=o.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;if(r)try{let e=encodeURIComponent(t),a=await fetch("https://maps.googleapis.com/maps/api/geocode/json?address=".concat(e,"&key=").concat(r));if(a.ok){let e=await a.json();if("OK"===e.status&&e.results&&e.results.length>0){let t=e.results[0].geometry.location;return{isValid:!0,coordinates:{latitude:t.lat,longitude:t.lng}}}console.warn("Google Maps Geocoding failed:",e.status)}}catch(e){console.error("Google Maps API error:",e)}return console.warn("Using fallback geocoding - add NEXT_PUBLIC_GOOGLE_MAPS_API_KEY for production"),{isValid:!0,coordinates:{latitude:40.7128+(Math.random()-.5)*.1,longitude:-74.006+(Math.random()-.5)*.1}}}catch(e){return console.error("Error verifying address:",e),{isValid:!1,error:"Address verification failed"}}}static async updateLocationUsage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;try{let r=await this.getLocationById(e);if(!r)return!1;let a=r.billing.monthlyUsage+t;return await this.updateLocation(e,{billing:{...r.billing,monthlyUsage:a}})}catch(e){return console.error("Error updating location usage:",e),!1}}static async getLocationUsageReport(e){try{let t=await this.getLocationsByBusinessId(e),r=t.length,a=t.filter(e=>e.billing.isActive).length,i=t.reduce((e,t)=>e+t.billing.monthlyUsage,0),n=t.map(e=>({locationId:e.id,name:e.name,monthlyUsage:e.billing.monthlyUsage,isActive:e.billing.isActive}));return{totalLocations:r,activeLocations:a,totalMonthlyUsage:i,locationBreakdown:n}}catch(e){return console.error("Error getting location usage report:",e),{totalLocations:0,activeLocations:0,totalMonthlyUsage:0,locationBreakdown:[]}}}static async createMenuItem(e){let t={...e,id:"menu_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),createdAt:new Date,updatedAt:new Date};try{let e=await this.initClient();if(!e||this.fallbackMode){let e=this.getFromMemory("menuItems")||[];return e.push(t),this.setInMemory("menuItems",e),t}return this.getConfig(),await e.send(new i.Z$({TableName:"jerktracker-menu-items",Item:t})),t}catch(r){console.error("Error creating menu item:",r);let e=this.getFromMemory("menuItems")||[];return e.push(t),this.setInMemory("menuItems",e),t}}static async getMenuItems(e){try{let t=await this.initClient();if(!t||this.fallbackMode)return(this.getFromMemory("menuItems")||[]).filter(t=>t.businessId===e);return(await t.send(new i.Zy({TableName:"jerktracker-menu-items",FilterExpression:"businessId = :businessId",ExpressionAttributeValues:{":businessId":e}}))).Items||[]}catch(t){return console.error("Error getting menu items:",t),(this.getFromMemory("menuItems")||[]).filter(t=>t.businessId===e)}}static async getMenuItemsByLocation(e,t){try{return(await this.getMenuItems(e)).filter(e=>!e.locationIds||0===e.locationIds.length||e.locationIds.includes(t))}catch(e){return console.error("Error getting menu items by location:",e),[]}}static async getMenuItemsByCategory(e,t){try{return(await this.getMenuItems(e)).filter(e=>e.category===t||e.customCategory===t)}catch(e){return console.error("Error getting menu items by category:",e),[]}}static async getMenuItem(e){try{let t=await this.initClient();if(!t||this.fallbackMode)return(this.getFromMemory("menuItems")||[]).find(t=>t.id===e)||null;return(await t.send(new i.s$({TableName:"jerktracker-menu-items",Key:{id:e}}))).Item||null}catch(t){return console.error("Error getting menu item:",t),(this.getFromMemory("menuItems")||[]).find(t=>t.id===e)||null}}static async updateMenuItem(e,t){try{let r=await this.initClient(),a={...t,id:e,updatedAt:new Date};if(!r||this.fallbackMode){let t=this.getFromMemory("menuItems")||[],r=t.findIndex(t=>t.id===e);if(-1!==r)return t[r]={...t[r],...a},this.setInMemory("menuItems",t),t[r];return null}let n=[],o={},s={};return Object.keys(t).forEach((e,r)=>{"id"!==e&&"createdAt"!==e&&(n.push("#field".concat(r," = :value").concat(r)),o["#field".concat(r)]=e,s[":value".concat(r)]=t[e])}),n.push("#updatedAt = :updatedAt"),o["#updatedAt"]="updatedAt",s[":updatedAt"]=new Date,await r.send(new i.fR({TableName:"jerktracker-menu-items",Key:{id:e},UpdateExpression:"SET ".concat(n.join(", ")),ExpressionAttributeNames:o,ExpressionAttributeValues:s,ReturnValues:"ALL_NEW"})),await this.getMenuItem(e)}catch(e){return console.error("Error updating menu item:",e),null}}static async deleteMenuItem(e){try{let t=await this.initClient();if(!t||this.fallbackMode){let t=(this.getFromMemory("menuItems")||[]).filter(t=>t.id!==e);return this.setInMemory("menuItems",t),!0}return await t.send(new i.fR({TableName:"jerktracker-menu-items",Key:{id:e},UpdateExpression:"REMOVE #item",ExpressionAttributeNames:{"#item":"id"}})),!0}catch(e){return console.error("Error deleting menu item:",e),!1}}static async searchMenuItems(e,t){try{let r=await this.getMenuItems(e),a=t.toLowerCase();return r.filter(e=>{var t,r;return e.name.toLowerCase().includes(a)||e.description.toLowerCase().includes(a)||e.category.toLowerCase().includes(a)||(null==(t=e.customCategory)?void 0:t.toLowerCase().includes(a))||(null==(r=e.allergens)?void 0:r.some(e=>e.toLowerCase().includes(a)))})}catch(e){return console.error("Error searching menu items:",e),[]}}static async createFraudClaim(e){try{let t=await this.initClient(),r=Date.now(),a="FC-".concat(new Date().getFullYear(),"-").concat(String(r).slice(-6)),n={...e,id:"claim_".concat(r,"_").concat(Math.random().toString(36).substr(2,9)),claimNumber:a,createdAt:new Date,updatedAt:new Date};if(!t||this.fallbackMode){let e=this.getFromMemory("fraudClaims")||[];return e.push(n),this.setInMemory("fraudClaims",e),n}return await t.send(new i.Z$({TableName:"jerktracker-fraud-claims",Item:n})),n}catch(e){throw console.error("Error creating fraud claim:",e),e}}static async getFraudClaims(e,t){try{let r=await this.initClient();if(!r||this.fallbackMode){let r=this.getFromMemory("fraudClaims")||[];return r=r.filter(t=>t.businessId===e),(null==t?void 0:t.status)&&(r=r.filter(e=>e.status===t.status)),(null==t?void 0:t.claimType)&&(r=r.filter(e=>e.claimType===t.claimType)),(null==t?void 0:t.priority)&&(r=r.filter(e=>e.priority===t.priority)),r.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())}let a=(await r.send(new i.Zy({TableName:"jerktracker-fraud-claims"}))).Items||[];return a=a.filter(t=>t.businessId===e),(null==t?void 0:t.status)&&(a=a.filter(e=>e.status===t.status)),(null==t?void 0:t.claimType)&&(a=a.filter(e=>e.claimType===t.claimType)),(null==t?void 0:t.priority)&&(a=a.filter(e=>e.priority===t.priority)),a.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())}catch(e){return console.error("Error getting fraud claims:",e),[]}}static async getFraudClaim(e){try{let t=await this.initClient();if(!t||this.fallbackMode)return(this.getFromMemory("fraudClaims")||[]).find(t=>t.id===e)||null;return(await t.send(new i.s$({TableName:"jerktracker-fraud-claims",Key:{id:e}}))).Item||null}catch(e){return console.error("Error getting fraud claim:",e),null}}static async updateFraudClaim(e,t){try{let r=await this.initClient(),a={...t,id:e,updatedAt:new Date};if(!r||this.fallbackMode){let t=this.getFromMemory("fraudClaims")||[],r=t.findIndex(t=>t.id===e);if(-1!==r)return t[r]={...t[r],...a},this.setInMemory("fraudClaims",t),t[r];return null}let n=[],o={},s={};return Object.keys(t).forEach((e,r)=>{"id"!==e&&"createdAt"!==e&&"claimNumber"!==e&&(n.push("#field".concat(r," = :value").concat(r)),o["#field".concat(r)]=e,s[":value".concat(r)]=t[e])}),n.push("#updatedAt = :updatedAt"),o["#updatedAt"]="updatedAt",s[":updatedAt"]=new Date,await r.send(new i.fR({TableName:"jerktracker-fraud-claims",Key:{id:e},UpdateExpression:"SET ".concat(n.join(", ")),ExpressionAttributeNames:o,ExpressionAttributeValues:s,ReturnValues:"ALL_NEW"})),await this.getFraudClaim(e)}catch(e){return console.error("Error updating fraud claim:",e),null}}static async resolveFraudClaim(e,t){try{return await this.updateFraudClaim(e,{...t,resolvedAt:new Date})}catch(e){return console.error("Error resolving fraud claim:",e),null}}static async getFraudClaimsByOrder(e){try{let t=await this.initClient();if(!t||this.fallbackMode)return(this.getFromMemory("fraudClaims")||[]).filter(t=>t.orderId===e);return((await t.send(new i.Zy({TableName:"jerktracker-fraud-claims"}))).Items||[]).filter(t=>t.orderId===e)}catch(e){return console.error("Error getting fraud claims by order:",e),[]}}static async getAllUsers(e){try{let t=await this.initClient();if(!t||this.fallbackMode){let t=this.getFromMemory("users")||[];return e&&(t=t.filter(t=>t.businessId===e)),t.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())}let r=(await t.send(new i.Zy({TableName:this.getUsersTableName()}))).Items||[];return e&&(r=r.filter(t=>t.businessId===e)),r.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())}catch(e){return console.error("Error getting users:",e),[]}}static async getUserById(e){try{let t=await this.initClient();if(!t||this.fallbackMode)return(this.getFromMemory("users")||[]).find(t=>t.id===e)||null;return(await t.send(new i.s$({TableName:this.getUsersTableName(),Key:{id:e}}))).Item||null}catch(e){return console.error("Error getting user by ID:",e),null}}static async createUser(e){try{let t=await this.initClient(),r=Date.now(),a={...e,id:"user_".concat(r,"_").concat(Math.random().toString(36).substr(2,9)),createdAt:new Date,updatedAt:new Date};if(!t||this.fallbackMode){let e=this.getFromMemory("users")||[];return e.push(a),this.setInMemory("users",e),a}return await t.send(new i.Z$({TableName:this.getUsersTableName(),Item:a})),a}catch(e){throw console.error("Error creating user:",e),e}}static async updateUser(e,t){try{let r=await this.initClient(),a={...t,id:e,updatedAt:new Date};if(!r||this.fallbackMode){let t=this.getFromMemory("users")||[],r=t.findIndex(t=>t.id===e);if(-1!==r)return t[r]={...t[r],...a},this.setInMemory("users",t),t[r];return null}let n=[],o={},s={};return Object.keys(t).forEach((e,r)=>{"id"!==e&&"createdAt"!==e&&(n.push("#field".concat(r," = :value").concat(r)),o["#field".concat(r)]=e,s[":value".concat(r)]=t[e])}),n.push("#updatedAt = :updatedAt"),o["#updatedAt"]="updatedAt",s[":updatedAt"]=new Date,await r.send(new i.fR({TableName:this.getUsersTableName(),Key:{id:e},UpdateExpression:"SET ".concat(n.join(", ")),ExpressionAttributeNames:o,ExpressionAttributeValues:s,ReturnValues:"ALL_NEW"})),await this.getUserById(e)}catch(e){return console.error("Error updating user:",e),null}}static async deleteUser(e){try{let t=await this.initClient();if(!t||this.fallbackMode){let t=(this.getFromMemory("users")||[]).filter(t=>t.id!==e);return this.setInMemory("users",t),!0}return await t.send(new i.fR({TableName:this.getUsersTableName(),Key:{id:e},UpdateExpression:"REMOVE #user",ExpressionAttributeNames:{"#user":"id"}})),!0}catch(e){return console.error("Error deleting user:",e),!1}}static async searchUsers(e,t){try{let r=await this.getAllUsers(t),a=e.toLowerCase();return r.filter(e=>{var t;return e.name.toLowerCase().includes(a)||e.email.toLowerCase().includes(a)||(null==(t=e.phone)?void 0:t.toLowerCase().includes(a))||e.role.toLowerCase().includes(a)})}catch(e){return console.error("Error searching users:",e),[]}}static async getUsersByRole(e,t){try{return(await this.getAllUsers(t)).filter(t=>t.role===e)}catch(e){return console.error("Error getting users by role:",e),[]}}static async updateUserSettings(e,t){try{return await this.updateUser(e,{settings:t})}catch(e){return console.error("Error updating user settings:",e),null}}static async updateDriverStatus(e,t){try{let r=await this.initClient();if(!r||this.fallbackMode)return console.log("Driver status update skipped: DynamoDB not available"),!1;return await r.send(new i.fR({TableName:this.getUsersTableName(),Key:{id:e},UpdateExpression:"SET driverInfo.availability = :status, updatedAt = :updatedAt",ExpressionAttributeValues:{":status":t,":updatedAt":new Date().toISOString()}})),!0}catch(e){return console.error("Error updating driver status:",e),!1}}static async getAvailableDrivers(){try{return(await this.getUsersByRole("driver")).filter(e=>{var t;return(null==(t=e.driverInfo)?void 0:t.availability)==="available"})}catch(e){return console.error("Error getting available drivers:",e),[]}}}l.client=null,l.fallbackMode=!1,l.ORDER_MEMORY_KEY="orders",l.memoryStorage={}}}]);